"""
================================================================================
LONG POLLING (ë¡± í´ë§)
================================================================================

[ ê°œë… ]
ì¼ë°˜ Pollingì˜ ê°œì„ ëœ ë²„ì „ì…ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ì„ ë³´ë‚´ë©´ ì„œë²„ê°€
"ì¦‰ì‹œ ì‘ë‹µí•˜ì§€ ì•Šê³ " ìƒˆë¡œìš´ ë°ì´í„°ê°€ ìƒê¸¸ ë•Œê¹Œì§€ ì‘ë‹µì„ ë³´ë¥˜í•©ë‹ˆë‹¤.
ë°ì´í„°ê°€ ìƒê¸°ë©´ ê·¸ë•Œ ì‘ë‹µí•˜ê³ , í´ë¼ì´ì–¸íŠ¸ëŠ” ì¦‰ì‹œ ë‹¤ì‹œ ìš”ì²­í•©ë‹ˆë‹¤.


================================================================================
ì‹¤í–‰ ë°©ë²•:
    í„°ë¯¸ë„ 1: python 02_long_polling.py server
    í„°ë¯¸ë„ 2: python 02_long_polling.py client  (ì„œë²„ê°€ ì¤€ë¹„ëë‹¤ëŠ” ë©”ì‹œì§€ í™•ì¸ í›„)
    
í•„ìš”í•œ íŒ¨í‚¤ì§€:
    pip install flask requests
================================================================================
"""

import sys
import time
import random
import threading
from datetime import datetime


# =============================================================================
# ì„œë²„ êµ¬í˜„
# =============================================================================

def run_server():
    """
    Long Polling ì„œë²„
    
    ì—­í• :
    - í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì´ ì˜¤ë©´ ìƒˆ ë°ì´í„°ê°€ ìƒê¸¸ ë•Œê¹Œì§€ ì‘ë‹µì„ ë³´ë¥˜
    - íƒ€ì„ì•„ì›ƒ(30ì´ˆ)ì´ ì§€ë‚˜ë©´ ë¹ˆ ì‘ë‹µ ë°˜í™˜
    - ë°±ê·¸ë¼ìš´ë“œì—ì„œ ëœë¤í•˜ê²Œ ë©”ì‹œì§€ ìƒì„± (ì‹œë®¬ë ˆì´ì…˜)
    
    í•µì‹¬ ì°¨ì´ì  (ì¼ë°˜ Pollingê³¼):
    - Polling: ìš”ì²­ ì¦‰ì‹œ ì‘ë‹µ
    - Long Polling: ë°ì´í„° ìˆì„ ë•Œê¹Œì§€ ì‘ë‹µ ë³´ë¥˜
    """
    
    from flask import Flask, jsonify, request
    
    app = Flask(__name__)
    
    # ë©”ì‹œì§€ ì €ì¥ì†Œ
    # âš ï¸ ì£¼ì˜: ì´ ì˜ˆì œì—ì„œëŠ” ë©”ì‹œì§€ê°€ ê³„ì† ìŒ“ì„ (ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” DB ì‚¬ìš© ë˜ëŠ” ì˜¤ë˜ëœ ë©”ì‹œì§€ ì‚­ì œ í•„ìš”)
    messages = []
    # ë©”ì‹œì§€ ID ì¹´ìš´í„°
    message_id = 0
    # ìŠ¤ë ˆë“œ ì•ˆì „ì„ ìœ„í•œ ë½ (ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— messagesì— ì ‘ê·¼í•  ìˆ˜ ìˆìŒ)
    lock = threading.Lock()
    
    # ---------------------------------------------------------
    # ë°±ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìƒì„±ê¸°
    # ---------------------------------------------------------
    def background_message_generator():
        """
        ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” ë©”ì‹œì§€ ìƒì„±ê¸°
        
        ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ”:
        - ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ë³´ëƒ„
        - ì™¸ë¶€ ì‹œìŠ¤í…œì—ì„œ ì´ë²¤íŠ¸ ë°œìƒ
        - DBì— ìƒˆ ë°ì´í„° ì¶”ê°€
        ë“±ì˜ ìƒí™©ì„ ì‹œë®¬ë ˆì´ì…˜
        """
        nonlocal message_id  # ì™¸ë¶€ ë³€ìˆ˜ ì°¸ì¡°
        
        while True:
            # 3~8ì´ˆ ëœë¤ ê°„ê²©ìœ¼ë¡œ ë©”ì‹œì§€ ìƒì„±
            time.sleep(random.uniform(3, 8))
            
            # ìŠ¤ë ˆë“œ ì•ˆì „í•˜ê²Œ ë©”ì‹œì§€ ì¶”ê°€
            with lock:
                message_id += 1
                new_msg = {
                    'id': message_id,
                    'text': f'ë©”ì‹œì§€ #{message_id}',
                    'time': datetime.now().strftime('%H:%M:%S')
                }
                messages.append(new_msg)
                print(f"ğŸ“¨ ìƒˆ ë©”ì‹œì§€ ìƒì„±: {new_msg['text']}")
    
    # ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ ì‹œì‘
    # daemon=True: ë©”ì¸ í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ ìë™ ì¢…ë£Œ
    thread = threading.Thread(target=background_message_generator, daemon=True)
    thread.start()
    
    # ---------------------------------------------------------
    # ë¼ìš°íŠ¸ ì •ì˜: GET /poll
    # ---------------------------------------------------------
    @app.route('/poll')
    def long_poll():
        """
        Long Polling ì—”ë“œí¬ì¸íŠ¸
        
        í•µì‹¬ ë¡œì§:
        1. í´ë¼ì´ì–¸íŠ¸ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ë°›ì€ ë©”ì‹œì§€ IDë¥¼ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
        2. ìƒˆ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‘ë‹µ
        3. ì—†ìœ¼ë©´ íƒ€ì„ì•„ì›ƒê¹Œì§€ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ë©° ëŒ€ê¸°
        4. íƒ€ì„ì•„ì›ƒë˜ë©´ ë¹ˆ ì‘ë‹µ ë°˜í™˜
        
        Query Parameters:
            last_id: í´ë¼ì´ì–¸íŠ¸ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ë°›ì€ ë©”ì‹œì§€ ID
            
        Returns:
            JSON: {
                'status': 'new_data' | 'timeout',
                'messages': [...]
            }
        """
        
        # === ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° íŒŒì‹± ===
        # request.args.get(): URLì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
        # ì˜ˆ: /poll?last_id=5 â†’ last_id = 5
        last_id = int(request.args.get('last_id', 0))
        
        # íƒ€ì„ì•„ì›ƒ ì„¤ì • (ì´ˆ)
        # ë„ˆë¬´ ê¸¸ë©´: ë¦¬ì†ŒìŠ¤ ë‚­ë¹„
        # ë„ˆë¬´ ì§§ìœ¼ë©´: ì¼ë°˜ Pollingê³¼ ë¹„ìŠ·í•´ì§
        timeout = 30
        start_time = time.time()
        
        print(f"â³ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ ë„ì°© (last_id={last_id}), ëŒ€ê¸° ì‹œì‘...")
        
        # === ë©”ì¸ ëŒ€ê¸° ë£¨í”„ ===
        # íƒ€ì„ì•„ì›ƒê¹Œì§€ ì£¼ê¸°ì ìœ¼ë¡œ ìƒˆ ë©”ì‹œì§€ í™•ì¸
        while time.time() - start_time < timeout:
            with lock:
                # ìƒˆ ë©”ì‹œì§€ í™•ì¸ (last_idë³´ë‹¤ í° IDë¥¼ ê°€ì§„ ë©”ì‹œì§€)
                new_messages = [m for m in messages if m['id'] > last_id]
                
                if new_messages:
                    # ìƒˆ ë©”ì‹œì§€ ë°œê²¬! ì¦‰ì‹œ ì‘ë‹µ
                    print(f"âœ… ìƒˆ ë©”ì‹œì§€ ë°œê²¬! {len(new_messages)}ê°œ ì „ì†¡")
                    return jsonify({
                        'status': 'new_data',
                        'messages': new_messages
                    })
            
            # 0.5ì´ˆë§ˆë‹¤ í™•ì¸ (CPU ì‚¬ìš© ìµœì†Œí™”)
            time.sleep(0.5)
        
        # === íƒ€ì„ì•„ì›ƒ ===
        # ìƒˆ ë©”ì‹œì§€ ì—†ì´ íƒ€ì„ì•„ì›ƒ â†’ ë¹ˆ ì‘ë‹µ
        print(f"â° íƒ€ì„ì•„ì›ƒ - ë¹ˆ ì‘ë‹µ ì „ì†¡")
        return jsonify({
            'status': 'timeout',
            'messages': []
        })
    
    # ---------------------------------------------------------
    # ì„œë²„ ì‹œì‘
    # ---------------------------------------------------------
    print("=" * 60)
    print("ğŸ–¥ï¸  LONG POLLING ì„œë²„ ì‹œì‘")
    print("=" * 60)
    print(f"ğŸ“ ì£¼ì†Œ: http://localhost:5001")
    print(f"ğŸ“ ì—”ë“œí¬ì¸íŠ¸: GET /poll?last_id=N")
    print(f"â° íƒ€ì„ì•„ì›ƒ: 30ì´ˆ")
    print("-" * 60)
    
    # â­ í´ë¼ì´ì–¸íŠ¸ ì‹¤í–‰ íƒ€ì´ë° ì•ˆë‚´
    print("\n" + "=" * 60)
    print("âœ… ì„œë²„ ì¤€ë¹„ ì™„ë£Œ!")
    print("ğŸ‘‰ ì´ì œ ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:")
    print("   python 02_long_polling.py client")
    print("=" * 60 + "\n")
    
    # threaded=True: ì—¬ëŸ¬ ìš”ì²­ì„ ë™ì‹œì— ì²˜ë¦¬
    # Long Pollingì€ ìš”ì²­ì´ ì˜¤ë˜ ìœ ì§€ë˜ë¯€ë¡œ í•„ìˆ˜
    
    # Flask/Werkzeug ë¡œê·¸ ë ˆë²¨ ì¡°ì • (ë¶ˆí•„ìš”í•œ ë¡œê·¸ ìˆ¨ê¹€)
    import logging
    log = logging.getLogger('werkzeug')
    log.setLevel(logging.ERROR)  # ERROR ì´ìƒë§Œ í‘œì‹œ
    
    app.run(port=5001, debug=False, threaded=True)


# =============================================================================
# í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„
# =============================================================================

def run_client():
    """
    Long Polling í´ë¼ì´ì–¸íŠ¸
    
    ì—­í• :
    - ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ê³  ì‘ë‹µì„ ê¸°ë‹¤ë¦¼ (ìµœëŒ€ 30ì´ˆ+)
    - ì‘ë‹µ ë°›ìœ¼ë©´ ì¦‰ì‹œ ë‹¤ì‹œ ìš”ì²­ (ëŒ€ê¸° ì‹œê°„ ì—†ìŒ)
    - íƒ€ì„ì•„ì›ƒë˜ë©´ ë°”ë¡œ ì¬ìš”ì²­
    
    í•µì‹¬ ì°¨ì´ì  (ì¼ë°˜ Pollingê³¼):
    - Polling: ì‘ë‹µ í›„ ì¼ì • ì‹œê°„ ëŒ€ê¸° í›„ ì¬ìš”ì²­
    - Long Polling: ì‘ë‹µ ë°›ìœ¼ë©´ ì¦‰ì‹œ ì¬ìš”ì²­
    """
    
    import requests
    
    print("=" * 60)
    print("ğŸ“± LONG POLLING í´ë¼ì´ì–¸íŠ¸ ì‹œì‘")
    print("=" * 60)
    print("ì„œë²„ê°€ ì‘ë‹µí•  ë•Œê¹Œì§€ ëŒ€ê¸°í•©ë‹ˆë‹¤...")
    print("-" * 60)
    print("(Ctrl+Cë¡œ ì¢…ë£Œ)\n")
    
    # ë§ˆì§€ë§‰ìœ¼ë¡œ ë°›ì€ ë©”ì‹œì§€ ID
    last_id = 0
    # ìš”ì²­ íšŸìˆ˜ ì¹´ìš´í„°
    request_num = 0
    
    # ---------------------------------------------------------
    # ë©”ì¸ Long Polling ë£¨í”„
    # ---------------------------------------------------------
    while True:
        try:
            request_num += 1
            timestamp = datetime.now().strftime('%H:%M:%S')
            
            print(f"[{timestamp}] ìš”ì²­ #{request_num}: ì„œë²„ì— ìš”ì²­, ì‘ë‹µ ëŒ€ê¸° ì¤‘... â³")
            
            # === HTTP GET ìš”ì²­ (Long Polling) ===
            # timeout=35: ì„œë²„ íƒ€ì„ì•„ì›ƒ(30ì´ˆ)ë³´ë‹¤ ê¸¸ê²Œ ì„¤ì •
            # ì„œë²„ê°€ ì‘ë‹µí•  ë•Œê¹Œì§€ ëŒ€ê¸°
            response = requests.get(
                f'http://localhost:5001/poll?last_id={last_id}',
                timeout=35
            )
            data = response.json()
            
            timestamp = datetime.now().strftime('%H:%M:%S')
            
            # === ì‘ë‹µ ì²˜ë¦¬ ===
            if data['status'] == 'new_data':
                # ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ 
                print(f"[{timestamp}] ìš”ì²­ #{request_num}: âœ… ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ !")
                for msg in data['messages']:
                    print(f"           â””â”€ {msg['text']} ({msg['time']})")
                    # ë§ˆì§€ë§‰ ë©”ì‹œì§€ ID ì—…ë°ì´íŠ¸
                    last_id = max(last_id, msg['id'])
            else:
                # íƒ€ì„ì•„ì›ƒ - ìƒˆ ë©”ì‹œì§€ ì—†ìŒ
                print(f"[{timestamp}] ìš”ì²­ #{request_num}: â° íƒ€ì„ì•„ì›ƒ, ì¬ì—°ê²°...")
            
            # â­ Long Pollingì˜ í•µì‹¬: ì‘ë‹µ ë°›ìœ¼ë©´ ì¦‰ì‹œ ì¬ìš”ì²­
            # ì¼ë°˜ Pollingê³¼ ë‹¬ë¦¬ time.sleep() ì—†ìŒ
            
        except requests.exceptions.ConnectionError:
            # ì„œë²„ ì—°ê²° ì‹¤íŒ¨
            print(f"âš ï¸  ì„œë²„ ì—°ê²° ì‹¤íŒ¨. 3ì´ˆ í›„ ì¬ì‹œë„...")
            time.sleep(3)
            
        except requests.exceptions.Timeout:
            # í´ë¼ì´ì–¸íŠ¸ íƒ€ì„ì•„ì›ƒ (ì„œë²„ê°€ 35ì´ˆ ë‚´ì— ì‘ë‹µ ì•ˆ í•¨)
            print(f"âš ï¸  ìš”ì²­ íƒ€ì„ì•„ì›ƒ. ì¬ì—°ê²°...")
            
        except KeyboardInterrupt:
            # Ctrl+Cë¡œ ì¢…ë£Œ
            print("\n\nğŸ‘‹ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            break


# =============================================================================
# ë©”ì¸ ì‹¤í–‰ë¶€
# =============================================================================

if __name__ == '__main__':
    if len(sys.argv) != 2 or sys.argv[1] not in ['server', 'client']:
        print(__doc__)
        print("\nì‚¬ìš©ë²•: python 02_long_polling.py [server|client]")
        print("\nì‹¤í–‰ ìˆœì„œ:")
        print("  1. í„°ë¯¸ë„ 1: python 02_long_polling.py server")
        print("  2. (ì„œë²„ ì¤€ë¹„ ë©”ì‹œì§€ í™•ì¸)")
        print("  3. í„°ë¯¸ë„ 2: python 02_long_polling.py client")
        sys.exit(1)
    
    if sys.argv[1] == 'server':
        run_server()
    else:
        run_client()

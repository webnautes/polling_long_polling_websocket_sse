"""
================================================================================
POLLING (í´ë§) - ì£¼ê¸°ì  ìš”ì²­ ë°©ì‹
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           POLLING ë™ì‘ ì›ë¦¬                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   í´ë¼ì´ì–¸íŠ¸                                        ì„œë²„                     â”‚
â”‚       â”‚                                              â”‚                      â”‚
â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€ [ìš”ì²­ #1] â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                      â”‚
â”‚       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ (ì¦‰ì‹œ ì‘ë‹µ)     â”‚  â† ë°ì´í„° ì—†ì–´ë„      â”‚
â”‚       â”‚         2ì´ˆ ëŒ€ê¸°                             â”‚    ì‘ë‹µ ë°˜í™˜          â”‚
â”‚       â”‚                                              â”‚                      â”‚
â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€ [ìš”ì²­ #2] â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                      â”‚
â”‚       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ (ì¦‰ì‹œ ì‘ë‹µ)     â”‚  â† ë°ì´í„° ì—†ì–´ë„      â”‚
â”‚       â”‚         2ì´ˆ ëŒ€ê¸°                             â”‚    ì‘ë‹µ ë°˜í™˜          â”‚
â”‚       â”‚                                              â”‚                      â”‚
â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€ [ìš”ì²­ #3] â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                      â”‚
â”‚       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ âœ¨ ìƒˆ ë°ì´í„°!   â”‚  â† ë“œë””ì–´ ë°ì´í„°!     â”‚
â”‚       â”‚         2ì´ˆ ëŒ€ê¸°                             â”‚                      â”‚
â”‚       â”‚                                              â”‚                      â”‚
â”‚       â–¼          ... ë¬´í•œ ë°˜ë³µ ...                   â–¼                      â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Œ í•µì‹¬: í´ë¼ì´ì–¸íŠ¸ê°€ "ì¼ì • ê°„ê²©"ìœ¼ë¡œ ì„œë²„ì— ìš”ì²­                           â”‚
â”‚  âš ï¸  ë‹¨ì : ë°ì´í„°ê°€ ì—†ì–´ë„ ìš”ì²­ ë°œìƒ â†’ ì„œë²„ ë¶€í•˜, ë„¤íŠ¸ì›Œí¬ ë‚­ë¹„              â”‚
â”‚  âœ… ì¥ì : êµ¬í˜„ì´ ê°„ë‹¨, ëª¨ë“  í™˜ê²½ì—ì„œ ë™ì‘                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
ì‹¤í–‰ ë°©ë²•:
    í„°ë¯¸ë„ 1: python 01_polling.py server
    í„°ë¯¸ë„ 2: python 01_polling.py client

í•„ìš”í•œ íŒ¨í‚¤ì§€:
    pip install flask requests
================================================================================
"""

import sys
import time
import random
from datetime import datetime


# =============================================================================
# ì„œë²„ êµ¬í˜„
# =============================================================================

def run_server():
    """Polling ì„œë²„ - ìš”ì²­ì´ ì˜¤ë©´ ì¦‰ì‹œ ì‘ë‹µ"""

    from flask import Flask, jsonify

    app = Flask(__name__)
    messages = []
    request_count = 0

    @app.route('/messages')
    def get_messages():
        nonlocal request_count
        request_count += 1
        timestamp = datetime.now().strftime('%H:%M:%S.%f')[:-3]

        # 30% í™•ë¥ ë¡œ ìƒˆ ë©”ì‹œì§€ ìƒì„± (ì‹œë®¬ë ˆì´ì…˜)
        new_message = None
        if random.random() > 0.7:
            new_message = {
                'id': len(messages) + 1,
                'text': f'ë©”ì‹œì§€ #{len(messages) + 1}',
                'time': timestamp
            }
            messages.append(new_message)

        # ===== í•µì‹¬ ë™ì‘ ì‹œê°í™” =====
        print()
        print(f"  [{timestamp}] â—€â”€â”€â”€ ìš”ì²­ #{request_count} ìˆ˜ì‹ ")

        if new_message:
            print(f"  [{timestamp}] â”€â”€â”€â–¶ âœ… ì‘ë‹µ: ìƒˆ ë©”ì‹œì§€ \"{new_message['text']}\"")
        else:
            print(f"  [{timestamp}] â”€â”€â”€â–¶ âŒ ì‘ë‹µ: ìƒˆ ë©”ì‹œì§€ ì—†ìŒ (ë¹ˆ ì‘ë‹µ)")
            print(f"               âš ï¸  ë°ì´í„° ì—†ì§€ë§Œ ìš”ì²­/ì‘ë‹µ ë°œìƒ (Polling ë‹¨ì )")

        return jsonify({
            'messages': messages[-5:],
            'total': len(messages),
            'has_new': new_message is not None
        })

    # ë¡œê·¸ ì„¤ì •
    import logging
    log = logging.getLogger('werkzeug')
    log.setLevel(logging.ERROR)

    print()
    print("â•”" + "â•" * 68 + "â•—")
    print("â•‘" + " " * 20 + "ğŸ–¥ï¸  POLLING ì„œë²„ ì‹œì‘" + " " * 27 + "â•‘")
    print("â• " + "â•" * 68 + "â•£")
    print("â•‘  ğŸ“ ì£¼ì†Œ: http://localhost:5000/messages" + " " * 26 + "â•‘")
    print("â•‘  ğŸ“Œ íŠ¹ì§•: ìš”ì²­ì´ ì˜¤ë©´ ë°ì´í„° ìœ ë¬´ì™€ ê´€ê³„ì—†ì´ 'ì¦‰ì‹œ' ì‘ë‹µ" + " " * 9 + "â•‘")
    print("â•š" + "â•" * 68 + "â•")
    print()
    print("â”Œ" + "â”€" * 68 + "â”")
    print("â”‚  âœ… ì„œë²„ ì¤€ë¹„ ì™„ë£Œ! ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ì‹¤í–‰:" + " " * 15 + "â”‚")
    print("â”‚     python 01_polling.py client" + " " * 35 + "â”‚")
    print("â””" + "â”€" * 68 + "â”˜")
    print()
    print("â”€" * 70)
    print("  ì•„ë˜ì—ì„œ ìš”ì²­/ì‘ë‹µ íë¦„ì„ í™•ì¸í•˜ì„¸ìš”:")
    print("â”€" * 70)

    app.run(port=5000, debug=False)


# =============================================================================
# í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„
# =============================================================================

def run_client():
    """Polling í´ë¼ì´ì–¸íŠ¸ - ì¼ì • ê°„ê²©ìœ¼ë¡œ ì„œë²„ì— ìš”ì²­"""

    import requests

    POLLING_INTERVAL = 2  # í´ë§ ê°„ê²© (ì´ˆ)

    print()
    print("â•”" + "â•" * 68 + "â•—")
    print("â•‘" + " " * 18 + "ğŸ“± POLLING í´ë¼ì´ì–¸íŠ¸ ì‹œì‘" + " " * 24 + "â•‘")
    print("â• " + "â•" * 68 + "â•£")
    print("â•‘  â° í´ë§ ê°„ê²©: 2ì´ˆë§ˆë‹¤ ì„œë²„ì— ìš”ì²­" + " " * 32 + "â•‘")
    print("â•‘  ğŸ“Œ íŠ¹ì§•: ë°ì´í„°ê°€ ì—†ì–´ë„ ê³„ì† ìš”ì²­ ë°œìƒ" + " " * 26 + "â•‘")
    print("â•š" + "â•" * 68 + "â•")
    print()
    print("  (Ctrl+Cë¡œ ì¢…ë£Œ)")
    print()
    print("â”€" * 70)
    print("  ğŸ“Š í†µê³„              â”‚  ğŸ“¡ ì‹¤ì‹œê°„ ìš”ì²­/ì‘ë‹µ")
    print("â”€" * 70)

    last_count = 0
    request_num = 0
    empty_responses = 0  # ë¹ˆ ì‘ë‹µ íšŸìˆ˜ (Polling ë‹¨ì  ì‹œê°í™”)
    data_responses = 0   # ë°ì´í„° ìˆëŠ” ì‘ë‹µ íšŸìˆ˜

    while True:
        try:
            request_num += 1
            timestamp = datetime.now().strftime('%H:%M:%S.%f')[:-3]

            # ===== ìš”ì²­ ì‹œê°í™” =====
            print()
            print(f"  ì´ ìš”ì²­: {request_num:3d}        â”‚  [{timestamp}] â”€â”€â”€â–¶ ì„œë²„ì— ìš”ì²­ #{request_num}")

            # HTTP GET ìš”ì²­
            start_time = time.time()
            response = requests.get('http://localhost:5000/messages', timeout=5)
            elapsed = (time.time() - start_time) * 1000  # ms

            data = response.json()
            current_count = data['total']
            timestamp = datetime.now().strftime('%H:%M:%S.%f')[:-3]

            # ===== ì‘ë‹µ ì‹œê°í™” =====
            if current_count > last_count:
                data_responses += 1
                new_count = current_count - last_count
                print(f"  ë°ì´í„° ìˆ˜ì‹ : {data_responses:3d}     â”‚  [{timestamp}] â—€â”€â”€â”€ âœ… ìƒˆ ë©”ì‹œì§€ {new_count}ê°œ! ({elapsed:.0f}ms)")
                for msg in data['messages'][-new_count:]:
                    print(f"  ë¹ˆ ì‘ë‹µ: {empty_responses:3d}        â”‚           â””â”€ \"{msg['text']}\"")
            else:
                empty_responses += 1
                print(f"  ë°ì´í„° ìˆ˜ì‹ : {data_responses:3d}     â”‚  [{timestamp}] â—€â”€â”€â”€ âŒ ìƒˆ ë©”ì‹œì§€ ì—†ìŒ ({elapsed:.0f}ms)")
                print(f"  ë¹ˆ ì‘ë‹µ: {empty_responses:3d}        â”‚           âš ï¸  ìš”ì²­ì€ í–ˆì§€ë§Œ ë°ì´í„° ì—†ìŒ!")

            # íš¨ìœ¨ì„± í‘œì‹œ
            if request_num > 0:
                efficiency = (data_responses / request_num) * 100
                print(f"  íš¨ìœ¨: {efficiency:5.1f}%       â”‚")

            last_count = current_count

            # ===== ëŒ€ê¸° ì‹œê°í™” =====
            print(f"                       â”‚  ğŸ’¤ {POLLING_INTERVAL}ì´ˆ ëŒ€ê¸° í›„ ë‹¤ìŒ ìš”ì²­...")
            time.sleep(POLLING_INTERVAL)

        except requests.exceptions.ConnectionError:
            print(f"  âš ï¸  ì„œë²„ ì—°ê²° ì‹¤íŒ¨! {POLLING_INTERVAL}ì´ˆ í›„ ì¬ì‹œë„...")
            time.sleep(POLLING_INTERVAL)
        except KeyboardInterrupt:
            print()
            print()
            print("â•" * 70)
            print(f"  ğŸ“Š ìµœì¢… í†µê³„")
            print("â”€" * 70)
            print(f"  ì´ ìš”ì²­ íšŸìˆ˜: {request_num}")
            print(f"  ë°ì´í„° ìˆ˜ì‹ : {data_responses}íšŒ")
            print(f"  ë¹ˆ ì‘ë‹µ: {empty_responses}íšŒ")
            if request_num > 0:
                print(f"  íš¨ìœ¨ì„±: {(data_responses / request_num) * 100:.1f}%")
            print()
            print("  âš ï¸  Pollingì˜ ë¬¸ì œì : ë¹ˆ ì‘ë‹µì´ ë§ì•„ ë¹„íš¨ìœ¨ì !")
            print("  ğŸ’¡ ê°œì„ ì•ˆ: Long Polling, WebSocket, SSE")
            print("â•" * 70)
            print()
            print("ğŸ‘‹ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            break


# =============================================================================
# ë©”ì¸ ì‹¤í–‰ë¶€
# =============================================================================

if __name__ == '__main__':
    if len(sys.argv) != 2 or sys.argv[1] not in ['server', 'client']:
        print(__doc__)
        print("\nì‚¬ìš©ë²•: python 01_polling.py [server|client]")
        print("\nì‹¤í–‰ ìˆœì„œ:")
        print("  1. í„°ë¯¸ë„ 1: python 01_polling.py server")
        print("  2. í„°ë¯¸ë„ 2: python 01_polling.py client")
        sys.exit(1)

    if sys.argv[1] == 'server':
        run_server()
    else:
        run_client()


"""
================================================================================
POLLING (í´ë§)
================================================================================

ì‹¤í–‰ ë°©ë²•:
    í„°ë¯¸ë„ 1: python 01_polling.py server
    í„°ë¯¸ë„ 2: python 01_polling.py client  (ì„œë²„ê°€ ì¤€ë¹„ëë‹¤ëŠ” ë©”ì‹œì§€ í™•ì¸ í›„)
    
í•„ìš”í•œ íŒ¨í‚¤ì§€:
    pip install flask requests
================================================================================
"""

import sys
import time
import random
from datetime import datetime


# =============================================================================
# ì„œë²„ êµ¬í˜„
# =============================================================================

def run_server():
    """
    Polling ì„œë²„
    
    ì—­í• :
    - í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ë°›ìœ¼ë©´ í˜„ì¬ ë©”ì‹œì§€ ëª©ë¡ì„ ì¦‰ì‹œ ë°˜í™˜
    - ë°ì´í„°ê°€ ìˆë“  ì—†ë“  ë°”ë¡œ ì‘ë‹µ (ëŒ€ê¸° ì—†ìŒ)
    - ì—¬ê¸°ì„œëŠ” 30% í™•ë¥ ë¡œ ìƒˆ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ì—¬ ì‹œë®¬ë ˆì´ì…˜
    """
    
    # Flask: íŒŒì´ì¬ì˜ ê²½ëŸ‰ ì›¹ í”„ë ˆì„ì›Œí¬
    # HTTP ìš”ì²­ì„ ì‰½ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ í•´ì¤Œ
    from flask import Flask, jsonify
    
    # Flask ì•± ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    # __name__: í˜„ì¬ ëª¨ë“ˆ ì´ë¦„, Flaskê°€ ë¦¬ì†ŒìŠ¤ ê²½ë¡œë¥¼ ì°¾ëŠ” ë° ì‚¬ìš©
    app = Flask(__name__)
    
    # ë©”ì‹œì§€ ì €ì¥ì†Œ (ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©)
    # ì„œë²„ ë©”ëª¨ë¦¬ì— ë©”ì‹œì§€ë¥¼ ì €ì¥
    # âš ï¸ ì£¼ì˜: ì´ ì˜ˆì œì—ì„œëŠ” ë©”ì‹œì§€ê°€ ê³„ì† ìŒ“ì„ (ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” DB ì‚¬ìš© ë˜ëŠ” ì˜¤ë˜ëœ ë©”ì‹œì§€ ì‚­ì œ í•„ìš”)
    messages = []
    
    # ---------------------------------------------------------
    # ë¼ìš°íŠ¸ ì •ì˜: GET /messages
    # ---------------------------------------------------------
    @app.route('/messages')
    def get_messages():
        """
        í´ë¼ì´ì–¸íŠ¸ê°€ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œí•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸
        
        ì²˜ë¦¬ íë¦„:
        1. (ì‹œë®¬ë ˆì´ì…˜) 30% í™•ë¥ ë¡œ ìƒˆ ë©”ì‹œì§€ ìƒì„±
        2. í˜„ì¬ ì €ì¥ëœ ë©”ì‹œì§€ ëª©ë¡ ë°˜í™˜
        3. ì¦‰ì‹œ ì‘ë‹µ - Pollingì˜ í•µì‹¬ íŠ¹ì§•
        
        Returns:
            JSON: {
                'messages': [...],  # ìµœê·¼ 5ê°œ ë©”ì‹œì§€
                'total': int        # ì „ì²´ ë©”ì‹œì§€ ìˆ˜
            }
        """
        
        # === ì‹œë®¬ë ˆì´ì…˜: ëœë¤í•˜ê²Œ ìƒˆ ë©”ì‹œì§€ ìƒì„± ===
        # ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” DBì—ì„œ ìƒˆ ë©”ì‹œì§€ë¥¼ ì¡°íšŒ
        # random.random(): 0.0 ~ 1.0 ì‚¬ì´ì˜ ëœë¤ ê°’
        if random.random() > 0.7:  # 30% í™•ë¥ 
            new_msg = {
                'id': len(messages) + 1,
                'text': f'ë©”ì‹œì§€ #{len(messages) + 1}',
                'time': datetime.now().strftime('%H:%M:%S')
            }
            messages.append(new_msg)
            print(f"ğŸ“¨ ìƒˆ ë©”ì‹œì§€ ìƒì„±: {new_msg['text']}")
        
        # === ì‘ë‹µ ë°˜í™˜ ===
        # jsonify: ë”•ì…”ë„ˆë¦¬ë¥¼ JSON ì‘ë‹µìœ¼ë¡œ ë³€í™˜
        # ìµœê·¼ 5ê°œ ë©”ì‹œì§€ë§Œ ë°˜í™˜ (messages[-5:])
        return jsonify({
            'messages': messages[-5:],
            'total': len(messages)
        })
    
    # ---------------------------------------------------------
    # ì„œë²„ ì‹œì‘
    # ---------------------------------------------------------
    print("=" * 60)
    print("ğŸ–¥ï¸  POLLING ì„œë²„ ì‹œì‘")
    print("=" * 60)
    print(f"ğŸ“ ì£¼ì†Œ: http://localhost:5000")
    print(f"ğŸ“ ì—”ë“œí¬ì¸íŠ¸: GET /messages")
    print("-" * 60)
    
    # â­ í´ë¼ì´ì–¸íŠ¸ ì‹¤í–‰ íƒ€ì´ë° ì•ˆë‚´
    print("\n" + "=" * 60)
    print("âœ… ì„œë²„ ì¤€ë¹„ ì™„ë£Œ!")
    print("ğŸ‘‰ ì´ì œ ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:")
    print("   python 01_polling.py client")
    print("=" * 60 + "\n")
    
    # Flask ê°œë°œ ì„œë²„ ì‹¤í–‰
    # port=5000: 5000ë²ˆ í¬íŠ¸ì—ì„œ ì‹¤í–‰
    # debug=False: ë””ë²„ê·¸ ëª¨ë“œ ë¹„í™œì„±í™” (ìë™ ì¬ì‹œì‘ ë°©ì§€)
    
    # Flask/Werkzeug ë¡œê·¸ ë ˆë²¨ ì¡°ì • (ë¶ˆí•„ìš”í•œ ë¡œê·¸ ìˆ¨ê¹€)
    import logging
    log = logging.getLogger('werkzeug')
    log.setLevel(logging.ERROR)  # ERROR ì´ìƒë§Œ í‘œì‹œ
    
    app.run(port=5000, debug=False)


# =============================================================================
# í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„
# =============================================================================

def run_client():
    """
    Polling í´ë¼ì´ì–¸íŠ¸
    
    ì—­í• :
    - ì¼ì • ê°„ê²©(2ì´ˆ)ìœ¼ë¡œ ì„œë²„ì— HTTP ìš”ì²­ì„ ë³´ëƒ„
    - ì‘ë‹µì—ì„œ ìƒˆ ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
    - ë°ì´í„°ê°€ ì—†ì–´ë„ ê³„ì† ìš”ì²­ (Pollingì˜ ë‹¨ì )
    """
    
    # requests: HTTP ìš”ì²­ì„ ë³´ë‚´ê¸° ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
    import requests
    
    # í´ë§ ê°„ê²© ì„¤ì • (ì´ˆ)
    # ì§§ìœ¼ë©´: ì‹¤ì‹œê°„ì„±â†‘, ì„œë²„ ë¶€í•˜â†‘
    # ê¸¸ë©´: ì‹¤ì‹œê°„ì„±â†“, ì„œë²„ ë¶€í•˜â†“
    POLLING_INTERVAL = 2
    
    print("=" * 60)
    print("ğŸ“± POLLING í´ë¼ì´ì–¸íŠ¸ ì‹œì‘")
    print("=" * 60)
    print(f"â° í´ë§ ê°„ê²©: {POLLING_INTERVAL}ì´ˆ")
    print("-" * 60)
    print("ì„œë²„ì— ì£¼ê¸°ì ìœ¼ë¡œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤...")
    print("(Ctrl+Cë¡œ ì¢…ë£Œ)\n")
    
    # ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸í•œ ë©”ì‹œì§€ ìˆ˜ (ìƒˆ ë©”ì‹œì§€ ê°ì§€ìš©)
    last_count = 0
    # ìš”ì²­ íšŸìˆ˜ ì¹´ìš´í„°
    request_num = 0
    
    # ---------------------------------------------------------
    # ë©”ì¸ í´ë§ ë£¨í”„
    # ---------------------------------------------------------
    while True:
        try:
            request_num += 1
            timestamp = datetime.now().strftime('%H:%M:%S')
            
            # === HTTP GET ìš”ì²­ ===
            # requests.get(): ì„œë²„ì— GET ìš”ì²­ ì „ì†¡
            # timeout=5: 5ì´ˆ ë‚´ì— ì‘ë‹µ ì—†ìœ¼ë©´ ì˜ˆì™¸ ë°œìƒ
            response = requests.get(
                'http://localhost:5000/messages',
                timeout=5
            )
            
            # === ì‘ë‹µ íŒŒì‹± ===
            # .json(): JSON ì‘ë‹µì„ íŒŒì´ì¬ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜
            data = response.json()
            current_count = data['total']
            
            # === ìƒˆ ë©”ì‹œì§€ í™•ì¸ ===
            if current_count > last_count:
                # ìƒˆ ë©”ì‹œì§€ê°€ ìˆëŠ” ê²½ìš°
                new_count = current_count - last_count
                print(f"[{timestamp}] ìš”ì²­ #{request_num}: âœ… ìƒˆ ë©”ì‹œì§€ {new_count}ê°œ ë°œê²¬!")
                
                # ìƒˆ ë©”ì‹œì§€ ì¶œë ¥
                for msg in data['messages'][-new_count:]:
                    print(f"           â””â”€ {msg['text']} ({msg['time']})")
            else:
                # ìƒˆ ë©”ì‹œì§€ê°€ ì—†ëŠ” ê²½ìš°
                # âš ï¸ Pollingì˜ ë‹¨ì : ë°ì´í„° ì—†ì–´ë„ ìš”ì²­ì´ ë°œìƒí•¨
                print(f"[{timestamp}] ìš”ì²­ #{request_num}: âŒ ìƒˆ ë©”ì‹œì§€ ì—†ìŒ")
            
            # ë©”ì‹œì§€ ìˆ˜ ì—…ë°ì´íŠ¸
            last_count = current_count
            
            # === ë‹¤ìŒ í´ë§ê¹Œì§€ ëŒ€ê¸° ===
            # time.sleep(): ì§€ì •ëœ ì‹œê°„(ì´ˆ) ë™ì•ˆ ëŒ€ê¸°
            time.sleep(POLLING_INTERVAL)
            
        except requests.exceptions.ConnectionError:
            # ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (ì„œë²„ê°€ êº¼ì ¸ìˆê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ)
            print(f"âš ï¸  ì„œë²„ ì—°ê²° ì‹¤íŒ¨. {POLLING_INTERVAL}ì´ˆ í›„ ì¬ì‹œë„...")
            time.sleep(POLLING_INTERVAL)
            
        except KeyboardInterrupt:
            # Ctrl+Cë¡œ ì¢…ë£Œ
            print("\n\nğŸ‘‹ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            break


# =============================================================================
# ë©”ì¸ ì‹¤í–‰ë¶€
# =============================================================================

if __name__ == '__main__':
    # ëª…ë ¹ì¤„ ì¸ì í™•ì¸
    # sys.argv[0]: ìŠ¤í¬ë¦½íŠ¸ ì´ë¦„
    # sys.argv[1]: ì²« ë²ˆì§¸ ì¸ì (server ë˜ëŠ” client)
    
    if len(sys.argv) != 2 or sys.argv[1] not in ['server', 'client']:
        # ì‚¬ìš©ë²• ì¶œë ¥
        print(__doc__)
        print("\nì‚¬ìš©ë²•: python 01_polling.py [server|client]")
        print("\nì‹¤í–‰ ìˆœì„œ:")
        print("  1. í„°ë¯¸ë„ 1: python 01_polling.py server")
        print("  2. (ì„œë²„ ì¤€ë¹„ ë©”ì‹œì§€ í™•ì¸)")
        print("  3. í„°ë¯¸ë„ 2: python 01_polling.py client")
        sys.exit(1)
    
    # ì¸ìì— ë”°ë¼ ì„œë²„ ë˜ëŠ” í´ë¼ì´ì–¸íŠ¸ ì‹¤í–‰
    if sys.argv[1] == 'server':
        run_server()
    else:
        run_client()
